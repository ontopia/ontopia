<?xml version="1.0"?>
<article> 
<title>The Navigator Tag Libraries</title>
<subtitle>Reference Documentation</subtitle>

<articleinfo>
<author>
<affiliation><orgname>Ontopia</orgname></affiliation>
</author>
<pubdate>2010-06-09</pubdate>
<releaseinfo>5.1</releaseinfo>

</articleinfo>

<!-- ......................................... intro ................. -->
<section> 
<title>Introduction</title> 

<para>
The general principle behind this tag library is that there is at all
times an execution context, which contains a number of variable
definitions. The values of variables are always collections of
objects. The tags can set new variable values, extract information
from old ones, and do simple conditionals and loops.
</para>

<para>
The framework consists of the following tag libraries:
</para>

<itemizedlist>
<listitem>
<para>
The tolog tag library is heavily based on tolog, which is used for all
extraction of information from the topic map, and tolog variables are
made available as tag library variables, and vice versa. (Note that
this tag library entirely replaces the old logic, tm, value, and
output tag libraries.)
</para>
</listitem>
<listitem>
<para>
The template tag library provides a simple page templating mechanism
that makes it possible to create single HTML templates for an entire
application and have each page insert content into named slots in this
template.
</para>
</listitem>
</itemizedlist>

<para>
The tags are embedded in an HTML document according to ordinary JSP
usage and the output-producing ones write their output directly into
the template. For a tutorial introduction to the tag libraries, see
<citetitle><ulink url="navguide.html">The Ontopia Navigator Framework:
Developer's Guide</ulink></citetitle>.
</para>

<note>
<para>The tolog tag library obsoletes several of <ulink
url="taglib2.html">the old tag libraries</ulink>. Their use is now
strongly discouraged, but they will continue to be supported as long
as they have users.</para>
</note>
</section>


<!-- ............................. general stuff .......................... -->
<section>
<title>General</title>

<para>
The root tag must always be the <xref linkend="tolog-context"/> tag.
</para>

<para>
All variables are set within a scope, that is, a region on the page in
which they are accessible. The page contains a hierarchy of such
scopes, with the one established by the <xref
linkend="tolog-context"/> tag as the root. Each <xref
linkend="tolog-foreach"/>, <xref linkend="tolog-if"/>, <xref
linkend="tolog-when"/>, and <xref linkend="tolog-otherwise"/> tag
creates a new scope inside itself.  Variables are visible from where
they are bound down to the end of the containing scope.
</para>

<para>
Variable names are required to match the following regular expression:
<literal>[A-Za-z_][A-Za-z0-9_-]*</literal>.
</para>
</section>

<!-- ............................. tolog taglib ........................... -->
<section>
<title>The tolog tags</title>

<!-- ===== TOLOG:CONTEXT ========================================--> 
<refentry id="tolog-context"> 
<refnamediv> 
<refname>tolog:context</refname> 

<refpurpose>Creates the context the other tags need to run.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
Sets up the Navigator Framework ready for execution. It may load a
topic map, if necessary, as well as the application configuration.
Finally, it establishes a lexical scope, but does not set any
variables.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>topicmap</entry> 
      <entry>false</entry> 
      <entry>topic map ID</entry> 
      <entry>The ID of the topic map to work on</entry> 
    </row> 
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Example</title> 

<para>
Below is a trivial example of the use of this tag.
</para>

<example>
<title>Using tolog:context</title>
<literallayout><![CDATA[<tolog:context topicmap="opera.ltm">
  <%-- use other tags to produce content here --%>
</tolog:context>]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:FOREACH ========================================--> 
<refentry id="tolog-foreach"> 
<refnamediv> 
<refname>tolog:foreach</refname> 

<refpurpose>Runs a tolog query and iterates over the result.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
The tag runs a tolog query, and executes its contents once for each
row in the result set. For each iteration, the values of the tolog
variables in that row are made available as navigator variables inside
the tag. (The tag creates a new lexical scope for these variables.)
</para>

<para>
The tag also supports grouping (such as when displaying all countries,
and for each a list of the cities in each country), which is done by
having two tolog:foreach tags nested within each other. The outermost
one will have a <symbol>query</symbol> attribute and a
<symbol>groupBy</symbol> attribute indicating which variable to group
by (in the example, country). It will iterate over the groups (in the
example, the countries). The innermost foreach tag will not have any
attributes, and will iterate over the elements in each group (in the
example, the cities).
</para>

<para>
It is possible to have more than one level of grouping, which is
achieved by having intermediate foreach elements which have a
<symbol>groupBy</symbol> attribute, but no <symbol>query</symbol>
attribute. So if we were to list all countries, with their provinces,
and the cities within each province, the outermost foreach would have
a query and group on country, while the next foreach would have no
query and group on province, while the innermost foreach would have no
attributes at all.
</para>

<para>
The foreach tag sets three variables on each iteration, described
below. These variables are independent of any grouping done by the
tag.
</para>

<variablelist>
  <varlistentry>
    <term>sequence-first</term>
    <listitem>
      <para>This variable will be true if this is the first iteration
      of the foreach tag, otherwise it will be false.</para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>sequence-last</term>
    <listitem>
      <para>This variable will be true if this is the last iteration
      of the foreach tag, otherwise it will be false.</para>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term>sequence-number</term>
    <listitem>
      <para>This variable will contain the number of this iteration of
      the foreach tag, starting with 1.</para>
    </listitem>
  </varlistentry>
</variablelist>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>query</entry> 
      <entry>No</entry> 
      <entry>tolog query</entry> 
      <entry>The query to run (or the name of a query declared with
      <xref linkend="tolog-query"/>).</entry> 
    </row> 
    <row> 
      <entry>separator</entry> 
      <entry>No</entry> 
      <entry>string</entry> 
      <entry>A string to be inserted between each iteration.</entry> 
    </row>
    <row> 
      <entry>groupBy</entry> 
      <entry>No</entry> 
      <entry>variable name(s)</entry> 
      <entry>The name(s) of the variable(s) to group on. If not
      present the tag will not do grouping. The variable names are
      separated by whitespace only.</entry> 
    </row>
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below shows a list of all composer topics in the topic
map.
</para>

<example>
<title>Simple use of tolog:foreach</title>
<literallayout><![CDATA[<ul>
<tolog:foreach query="instance-of($composer, composer)?">
  <%-- the composer variable is now set by the :foreach tag --%>
  <li><tolog:out var="composer"/></li> 
</tolog:foreach>
</ul>]]></literallayout>
</example>

<para>
The next example shows a list of composers, and for each composer all
the operas he<footnote><para>The Italian Opera Topic Map only contains
male composers.</para></footnote> has composed. This is done in a
single query using grouping.
</para>

<example>
<title>Using tolog:foreach with groupBy</title>
<literallayout><![CDATA[<ul>
<tolog:foreach query="composed-by($COMPOSER : composer, $OPERA : opera)
                      order by $COMPOSER?" 
               groupBy="COMPOSER">

  <%-- the COMPOSER variable is now set by the :foreach tag,
       but not OPERA; repeated once for each COMPOSER --%>

  <li><tolog:out var="COMPOSER"/>
    <ul>
      <tolog:foreach>
        <%-- OPERA is now set; repeated once for each OPERA with the
             current COMPOSER --%>
        <li><tolog:out var="OPERA"/>
      </tolog:foreach>
    </ul>
  </li>
</tolog:foreach>
</ul>]]></literallayout>
</example>

<para>
The next example lists all operas composed by Puccini with commas in
between their names, except between the last two, which are separated
by "and". In addition, the number of each opera in the sequence is
added in parentheses behind its name.
</para>

<example>
<title>Using the <symbol>sequence-*</symbol> variables</title>
<literallayout><![CDATA[<tolog:foreach query="composed-by(puccini : composer, $OPERA : work)?">
  <tolog:choose>
     <tolog:when var="sequence-first"></tolog:when>
     <tolog:when var="sequence-last"> and </tolog:when>
     <tolog:otherwise>, </tolog:otherwise>
  </tolog:choose>
  <tolog:out value="OPERA"/> (<tolog:out value="sequence-number"/>)
</tolog:foreach>]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:OUT ============================================--> 
<refentry> 
<refnamediv> 
<refname>tolog:out</refname> 

<refpurpose>Outputs a value from a variable or a query.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
This tag gets a value either by running a query or picking it out of a
variable and then outputs it. The table below shows what is output for
different kinds of values. The tag must be empty.
</para>

<table>
<title>Outputs for different types</title>
<tgroup cols="2">
<thead>
<row>
  <entry>Type</entry>
  <entry>Output</entry>
</row>
</thead>
<tbody>
<row>
  <entry>string</entry>
  <entry>output as is</entry>
</row>
<row>
  <entry>locator</entry>
  <entry>external form is output</entry>
</row>
<row>
  <entry>topic</entry>
  <entry>most suitable named picked and output</entry>
</row>
<row>
  <entry>basename</entry>
  <entry>string value is output</entry>
</row>
<row>
  <entry>variant</entry>
  <entry>string value or external form of locator is output</entry>
</row>
<row>
  <entry>occurrence</entry>
  <entry>string value or external form of locator is output</entry>
</row>
<row>
  <entry>other</entry>
  <entry>result of calling <methodname>toString</methodname> is
  output</entry>
</row>
</tbody>
</tgroup>
</table>

<para>
If the <symbol>query</symbol> attribute is used it is an error for the
query to return a result set with more than one column. If the query
produces more than one row only the first row is used.
</para>

<para>
If the <symbol>var</symbol> attribute is set to a variable that either
is not set, does not contain anything, or contains null it is an error.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>query</entry> 
      <entry>No</entry> 
      <entry>tolog query</entry> 
      <entry>The query to run (or the name of a query declared with
      <xref linkend="tolog-query"/>). Either this or
      <symbol>var</symbol> must be set.</entry>
    </row> 
    <row> 
      <entry>var</entry> 
      <entry>No</entry> 
      <entry>variable name or JSP attribute</entry> 
      <entry>The name of the variable whose value is to be output.
      Note that if the variable contains more than one value a random
      value is picked. If no variable is found, a JSP attribute will
      be looked up, and bean properties accessed. (Either this
      attribute or <symbol>query</symbol> must be set.)</entry>
    </row>
    <row> 
      <entry>scope</entry> 
      <entry>No</entry> 
      <entry>variable name</entry> 
      <entry>Specifies the scope to be used when selecting names for
      topics; has no effect on other objects.</entry>
    </row>
    <row> 
      <entry>escape</entry> 
      <entry>No</entry> 
      <entry>true | false</entry> 
      <entry>If true (which is the default) the output has any
      reserved XML/HTML characters escaped; this can be turned off by
      setting the value to false.</entry>
    </row>
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below shows a list of all composer topics in the topic
map using the <symbol>var</symbol> attribute.
</para>

<example>
<title>Simple use of tolog:out</title>
<literallayout><![CDATA[<ul>
<tolog:foreach query="instance-of($composer, composer)?">
  <%-- the out tag will pick the best name for the composer topic and
       output it --%>
  <li><tolog:out var="composer"/></li> 
</tolog:foreach>
</ul>]]></literallayout>
</example>

<para>
The example below shows how the <symbol>query</symbol> attribute can
be used to pick the value to output. The query counts the number of
topics in the topic map, and the <symbol>tolog:out</symbol> tag will
print this number.
</para>

<example>
<title>Using tolog:out with a query</title>
<literallayout><![CDATA[<p>
This topic map contains 
<tolog:out query="select count($T) from topic($T)?"/>
topics.</p>]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:IF =============================================--> 
<refentry id="tolog-if"> 
<refnamediv> 
<refname>tolog:if</refname> 

<refpurpose>Executes its contents depending on the value of a variable
or the result of a query.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
This tag either tests the value of a variable or the result of a
query. The variable is considered true if it is set and contains
values other than null. The query is considered true if it produces at
least one result row. If a query is run, navigator variables for each
tolog variable bound in the first row will be set. Later rows, if any,
will be ignored.
</para>

<para>
The <symbol>tolog:if</symbol> tag introduces a new lexical scope.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>query</entry> 
      <entry>No</entry> 
      <entry>tolog query</entry> 
      <entry>The query to run (or the name of a query declared with
      <xref linkend="tolog-query"/>). Either this or
      <symbol>var</symbol> must be set.</entry>
    </row> 
    <row> 
      <entry>var</entry> 
      <entry>No</entry> 
      <entry>variable name</entry> 
      <entry>The name of the variable whose value is to be tested.
      (Either this attribute or <symbol>query</symbol> must be
      set.)</entry>
    </row>
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below loops over all operas in the topic map, outputting
for each the name and, if set, the premiere date.
</para>

<example>
<title>Using tolog:if with a variable</title>
<literallayout><![CDATA[<ul>
<tolog:foreach query="instance-of($opera, opera),
                      { premiere-date($opera, $date) }?">
  <%-- 'opera' and 'date' will be set here, but 'date' may be null --%>
  <li><tolog:out var="opera"/>
    <tolog:if var="date">(<tolog:out var="date"/>)</tolog:if>
  </li> 
</tolog:foreach>
</ul>]]></literallayout>
</example>

<para>
The example below does the same thing, except that it runs a separate
query to check the premiere date for each opera.
</para>

<example>
<title>Using tolog:if with a query</title>
<literallayout><![CDATA[<ul>
<tolog:foreach query="instance-of($opera, opera)?">
  <%-- 'opera' will be set here --%>
  <li><tolog:out var="opera"/>
    <tolog:if query="premiere-date(%opera%, $date)?">
      <%-- if there is no date we won't get here; if we get here
           'date' will be set --%>
      <tolog:out var="date"/>
    </tolog:if>
  </li> 
</tolog:foreach>
</ul>]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:CHOOSE =============================================--> 
<refentry id="tolog-choose"> 
<refnamediv> 
<refname>tolog:choose</refname> 

<refpurpose>Container for <xref linkend="tolog-when"/> and <xref
linkend="tolog-otherwise"/> tags; used for complex tests.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
This tag executes its children until the first <xref
linkend="tolog-when"/> child succeeds; if none of the <xref
linkend="tolog-when"/> children succeed the <xref
linkend="tolog-otherwise"/> is executed, if present. At least one
<xref linkend="tolog-when"/> or <xref linkend="tolog-otherwise"/> child
must be present. The <symbol>tolog:choose</symbol> tag does not
introduce a new lexical scope.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title>

<para>
This tag has no attributes.
</para>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below links to different JSP pages depending on the type
of the topic in the <symbol>topic</symbol> variable. This sort of
construct is used on general search pages and suchlike.
</para>

<example>
<title>Using tolog:choose</title>
<literallayout><![CDATA[<%-- 'topic' is already set --%>
<tolog:choose>
  <tolog:when query="instance-of(%topic%, composer)?">
    <a href="composer.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:when query="instance-of(%topic%, opera)?">
    <a href="opera.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:when query="instance-of(%topic%, country)?">
    <a href="country.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:otherwise>
    <tolog:out var="topic"/> <%-- no link here --%>
  </tolog:otherwise>
</tolog:choose>
]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:WHEN ==============================================--> 
<refentry id="tolog-when"> 
<refnamediv> 
<refname>tolog:when</refname> 

<refpurpose>Conditional test, almost identical to <xref
linkend="tolog-if"/>, but only used within <xref
linkend="tolog-choose"/>.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
Used within <xref linkend="tolog-choose"/> (and only there) for
conditional testing. The first tolog:when within a <xref
linkend="tolog-choose"/> whose test evaluates to true will have its
children executed; after this, no more tolog:whens will be tested.
</para>

<para>
tolog:when has the same attributes as <xref linkend="tolog-if"/> and
the same rules are used to establish whether the test evaluates to
true or false.   
</para>

<para>
The <symbol>tolog:when</symbol> tag introduces a new lexical scope.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>query</entry> 
      <entry>No</entry> 
      <entry>tolog query</entry> 
      <entry>The query to run (or the name of a query declared with
      <xref linkend="tolog-query"/>). Either this or
      <symbol>var</symbol> must be set.</entry>
    </row> 
    <row> 
      <entry>var</entry> 
      <entry>No</entry> 
      <entry>variable name</entry> 
      <entry>The name of the variable whose value is to be tested.
      (Either this attribute or <symbol>query</symbol> must be
      set.)</entry>
    </row>
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below links to different JSP pages depending on the type
of the topic in the <symbol>topic</symbol> variable. This sort of
construct is used on general search pages and suchlike.
</para>

<example>
<title>Using tolog:choose</title>
<literallayout><![CDATA[<%-- 'topic' is already set --%>
<tolog:choose>
  <tolog:when query="instance-of(%topic%, composer)?">
    <a href="composer.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:when query="instance-of(%topic%, opera)?">
    <a href="opera.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:when query="instance-of(%topic%, country)?">
    <a href="country.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:otherwise>
    <tolog:out var="topic"/> <%-- no link here --%>
  </tolog:otherwise>
</tolog:choose>
]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:OTHERWISE =========================================--> 
<refentry id="tolog-otherwise"> 
<refnamediv> 
<refname>tolog:otherwise</refname> 

<refpurpose>Used within <xref linkend="tolog-choose"/> at the end for
a clause that will be executed if no <xref linkend="tolog-when"/> tags
are executed.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
Used within <xref linkend="tolog-choose"/> (and only there) at the end
as a kind of 'else' or 'default branch', which will be executed if
none of the <xref linkend="tolog-when"/> tags in the <xref
linkend="tolog-choose"/> are executed.
</para>

<para>
The <symbol>tolog:otherwise</symbol> tag introduces a new lexical scope.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 

<para>
This tag has no attributes.
</para>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below links to different JSP pages depending on the type
of the topic in the <symbol>topic</symbol> variable. This sort of
construct is used on general search pages and suchlike. Note the
tolog:otherwise at the end, which is used to just display the name of
the topic with no link if it's not of one of the recognized types.
</para>

<example>
<title>Using tolog:choose</title>
<literallayout><![CDATA[<%-- 'topic' is already set --%>
<tolog:choose>
  <tolog:when query="instance-of(%topic%, composer)?">
    <a href="composer.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:when query="instance-of(%topic%, opera)?">
    <a href="opera.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:when query="instance-of(%topic%, country)?">
    <a href="country.jsp?id=..."><tolog:out var="topic"/></a>
  </tolog:when>
  <tolog:otherwise>
    <tolog:out var="topic"/> <%-- no link here --%>
  </tolog:otherwise>
</tolog:choose>
]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:SET ==============================================--> 
<refentry id="tolog-set"> 
<refnamediv> 
<refname>tolog:set</refname> 

<refpurpose>Used to set navigator framework variables.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
Sets the value of a navigator framework variable. This is generally
used when working with the Web Editor Framework, or to interact with
non-Ontopia tags and code. The tolog:set set tag must always be empty.
</para>

<para>
If a tolog query is used it must produce exactly one column in the
result set. The variable set will be given the name in the
<symbol>var</symbol> attribute (if present) or the name of the tolog
variable (if <symbol>var</symbol> is not present). Each row in the
result set will contribute one element to the collection to be bound
to the variable.
</para>

<para>
The <symbol>reqparam</symbol> attribute can be used to get topics from
HTTP request parameters. The request parameter must contain an object
ID or a symbolic ID, which will be looked up in the topic map, and the
corresponding object set as the value of the variable. If the
<symbol>reqparam</symbol> attribute is used the <symbol>var</symbol>
attribute must be present. (If the request parameter has multiple
values the same procedure is applied to each value.)
</para>

<para>
The <symbol>scope</symbol> attribute can be used to set values as JSP
container attributes instead of as Navigator Framework variables. See
the documentation for this attribute for details.
</para>

<para>
The <symbol>value</symbol> attribute can be used instead of the
<symbol>query</symbol> attribute to compute the value to be set. This
attribute takes a <ulink
url="http://java.sun.com/j2ee/1.4/docs/tutorial/doc/JSPIntro7.html">JSP
expression</ulink> as its value, and the JSP expression computes the
value of the variable. See the attribute documentation for details.
</para>

<para>
Finally, the tag can be used with only the <symbol>var</symbol>
attribute and the variable will then be set to the string value of the
content of the tag. If the tag is empty it the variable will be set to
the empty collection.
</para>

<para>
The <symbol>tolog:set</symbol> tag does not introduce a new lexical
scope.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>query</entry> 
      <entry>no</entry> 
      <entry>tolog query</entry> 
      <entry>The query which produces the value put into the variable
      (or the name of a query declared with <xref
      linkend="tolog-query"/>).</entry>
    </row> 
    <row> 
      <entry>var</entry> 
      <entry>no</entry> 
      <entry>variable name</entry> 
      <entry>The name of the variable to set. If not given the name
      will be that of the variable in the tolog query.</entry>
    </row>
    <row> 
      <entry>reqparam</entry> 
      <entry>no</entry> 
      <entry>HTTP request parameter name</entry> 
      <entry>If given, the variable set will be set to the topic map
      object whose ID is the value of the named HTTP request parameter
      to the page. If the request parameter is not given the variable
      will be bound to an empty value.</entry>
    </row>
    <row> 
      <entry>scope</entry> 
      <entry>no</entry> 
      <entry>application | session | request | page | ontopia</entry> 
      <entry>Controls where the variable is set. If value is
      <literal>ontopia</literal> (which is the default) the variable is
      set as a Navigator Framework variable. If not, it is set as a
      JSP container attribute, and not as a Navigator Framework
      variable at all.  The values other than <literal>ontopia</literal>
      indicate which scope in the JSP container the attribute is to be
      set in.</entry>
    </row>
    <row> 
      <entry>value</entry> 
      <entry>no</entry> 
      <entry><ulink
      url="http://java.sun.com/j2ee/1.4/docs/tutorial/doc/JSPIntro7.html">JSP
      expression</ulink></entry>
      <entry>The JSP expression computes the value to be set. Note
      that when scope is <literal>ontopia</literal> values that are arrays
      will be converted to collections, collections will stay as
      collections, and anything else (including null) will become
      singleton collections. (This is done because Navigator Framework
      variables are always bound to collections and never to single
      values.)</entry>
    </row>
  </tbody> 
</tgroup> 
</informaltable>

<para>
Note that either <symbol>query</symbol>, <symbol>value</symbol>, or
<symbol>reqparam</symbol> must be set, or the tag must have content,
which will become the string value of the variable.
</para>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below sets the variable 'composers' to the collection of
all composer topics in the topic map.
</para>

<example>
<title>Using tolog:set with many values</title>
<literallayout><![CDATA[<tolog:set var="composers"
           query="instance-of($COMPOSER, composer)?"/>]]></literallayout>
</example>

<para>
The next example sets the 'composer' topic into the variable 'composer'.
</para>

<example>
<title>Using tolog:set with one value</title>
<literallayout><![CDATA[<tolog:set query='source-locator($composer, "#composer")?'/>]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:OID ==============================================--> 
<refentry> 
<refnamediv> 
<refname>tolog:oid</refname> 

<refpurpose>Outputs the object ID of a topic map object.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
This tag gets a value either by running a query or picking it out of a
variable and then outputs its object ID, provided it is a topic map
object.  It is an error if the value is not a topic map object. The
tag must be empty.
</para>

<para>
Note that the object ID of a topic map object is
<emphasis>not</emphasis> the same as its ID in an XTM or LTM file.
The ID in a file is likely to be meaningful, but the object ID is a
meaningless identifier assigned automatically by the topic map engine.
(At present this will be a number.)
</para>

<para>
If the <symbol>query</symbol> attribute is used it is an error for the
query to return a result set with more than one column. If the query
produces more than one row only the first row is used.
</para>

<para>
If the <symbol>var</symbol> attribute is set to a variable that either
is not set, does not contain anything, or contains null it is an error.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>query</entry> 
      <entry>No</entry> 
      <entry>tolog query</entry> 
      <entry>The query to run (or the name of a query declared with
      <xref linkend="tolog-query"/>). Either this or
      <symbol>var</symbol> must be set.</entry>
    </row> 
    <row> 
      <entry>var</entry> 
      <entry>No</entry> 
      <entry>variable name or JSP attribute</entry> 
      <entry>The name of the variable whose value is to be output.
      Note that if the variable contains more than one value a random
      value is picked. If no variable is found, a JSP attribute will
      be looked up, and bean properties accessed. (Either this attribute or
      <symbol>query</symbol> must be set.)</entry>
    </row>
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Examples</title> 


<para>
The example below uses the already bound <symbol>composer</symbol>
variable to create a link to the topic in that variable.
</para>

<example>
<title>Using tolog:oid in a link</title>
<literallayout><![CDATA[<p>
This opera was composed by <a href="composer.jsp?id=<tolog:oid
var="composer"/>"><tolog:out var="composer"/></a>.</p>]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:ID ==============================================--> 
<refentry> 
<refnamediv> 
<refname>tolog:id</refname> 

<refpurpose>Outputs a symbolic ID of a topic map object.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
This tag gets a value either by running a query or picking it out of a
variable and then outputs its symbolic ID, provided it is a topic map
object.  It is an error if the value is not a topic map object. The
tag must be empty.
</para>

<para>
The symbolic ID is found by searching for a source locator for the
object of the form <symbol>foo#bar</symbol> where <symbol>foo</symbol>
is the same URI as the base address of the topic map store. The ID
will then be <symbol>bar</symbol>, which would correspond to the ID of
the topic/object in an XTM/LTM file. If no matching source locator is
found the object ID will be used instead.
</para>

<para>
If the <symbol>query</symbol> attribute is used it is an error for the
query to return a result set with more than one column. If the query
produces more than one row only the first row is used.
</para>

<para>
If the <symbol>var</symbol> attribute is set to a variable that either
is not set, does not contain anything, or contains null it is an error.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>query</entry> 
      <entry>No</entry> 
      <entry>tolog query</entry> 
      <entry>The query to run (or the name of a query declared with
      <xref linkend="tolog-query"/>). Either this or
      <symbol>var</symbol> must be set.</entry>
    </row> 
    <row> 
      <entry>var</entry> 
      <entry>No</entry> 
      <entry>variable name or JSP attribute</entry> 
      <entry>The name of the variable whose value is to be output.
      Note that if the variable contains more than one value a random
      value is picked. If no variable is found, a JSP attribute will
      be looked up, and bean properties accessed. (Either this attribute or
      <symbol>query</symbol> must be set.)</entry>
    </row>
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below uses the already bound <symbol>composer</symbol>
variable to create a link to the topic in that variable.
</para>

<example>
<title>Using tolog:id in a link</title>
<literallayout><![CDATA[<p>
This opera was composed by <a href="composer.jsp?id=<tolog:id
var="composer"/>"><tolog:out var="composer"/></a>.</p>]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:DECLARE ===========================================--> 
<refentry> 
<refnamediv> 
<refname>tolog:declare</refname> 

<refpurpose>Used to make tolog declarations available to all queries
in the same <xref linkend="tolog-context"/>.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
This tag makes it possible to declare tolog URI prefixes, module
imports, and inference rules once in a single page, and then reuse
them in other queries below their first declaration. Note that the
declarations will be visible throughout the entire <xref
linkend="tolog-context"/> tag in which the tag occurs below the point
at which it occurs.
</para>

<para>
The <symbol>tolog:declare</symbol> tag does not introduce a new lexical
scope.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 

<para>
This tag has no attributes.
</para>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below first defines a URI prefix, then makes use of it in
a query below.
</para>

<example>
<title>Using tolog:declare</title>
<literallayout><![CDATA[<tolog:declare>
using xtm for i"http://www.topicmaps.org/xtm/1.0/#"
</tolog:declare>

<p>The <tolog:out var="class"/> class has the following
subclasses:</p>

<ul>
<tolog:foreach query="
  xtm:superclass-subclass(%class% : xtm:superclass, $SUB : xtm:subclass)?">
  <li><tolog:out var="SUB"/></li>
</tolog:foreach>
</ul>]]></literallayout>
</example>
</refsect1>
</refentry>

<!-- ===== TOLOG:QUERY =============================================--> 
<refentry id="tolog-query"> 
<refnamediv> 
<refname>tolog:query</refname> 

<refpurpose>Defines a named query which can later be referenced from
other tolog tags.</refpurpose>
</refnamediv>

<refsect1> 
<title>Description</title> 

<para>
This tag captures the output from its contents and stores it as a
named tolog query in the page context. The query can later be
referenced by name from other tolog tags in their
<symbol>query</symbol> attributes.
</para>

<para>
The <symbol>tolog:query</symbol> tag does not introduce a new lexical
scope.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 

<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>name</entry> 
      <entry>yes</entry> 
      <entry>tolog query name</entry> 
      <entry>The name under which the query is to be stored.</entry>
    </row> 
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Examples</title> 

<para>
The example below uses a named query to avoid having to repeat the
same query twice. The query lists all cities within a country, and is
used first to check if the country has any cities, in which case a
list of them is written out.
</para>

<example>
<title>Reusing a named query</title>
<literallayout><![CDATA[
<tolog:query name="q-cities">
located-in(%country% : container, $CITY : containee),
instance-of($CITY, city)
order by $CITY?
</tolog:query>

<tolog:if query="q-cities">
<p><tolog:out var="country"> contains these cities:</p>

<ul>
  <tolog:foreach query="q-cities">
    <li><tolog:out var="CITY"/></li>
  </tolog:foreach>
</ul>
</tolog:if>
]]></literallayout>
</example>
</refsect1>
</refentry>
</section>

<!-- ............................. template taglib ........................ -->
<section> 
<title>The templating tags</title> 

<para>
These tags are used to implement JSP page templating, which can be
used to avoid having to repeat the page layout structure in every
single JSP page. They can also be used to implement a full
Model-View-Skin system.
</para> 

<refentry> 
<refnamediv> 
<refname>insert</refname> 

<refpurpose>References the template JSP page to be used by the current
page.</refpurpose>
</refnamediv>

<refsect1> 
<title>Context interaction</title> 

<para>
This tag does not make any assumptions about its ancestors.
</para>

<para>
This tag should contain <symbol>template:put</symbol> tags, which
assign contents to the slots defined by the template page.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 
<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>template</entry> 
      <entry>Yes</entry> 
      <entry>Path</entry> 
      <entry>The path is relative to the referencing page.</entry> 
    </row> 
  </tbody> 
</tgroup> 
</informaltable>
</refsect1>

<refsect1> 
<title>Execution</title> 

<para>
This tag is used in JSP pages to say what template the page should
use. Execution is done by executing the contents of the tag, which
stores the contents written into the various page slots. The template
page is then output with the contents of the various slots inserted in
the right places.
</para>
</refsect1>

<refsect1>
<title>Example</title>

<para>
Below is an example of the use of how the three templating tags are
used together. The <filename>demo.jsp</filename> requested by the
client uses the template (as defined in
<filename>template.jsp</filename> as listed a bit further down).
</para>

<example>
<title>Referring to the template with the insert tag
(<filename>demo.jsp</filename>)</title>

<literallayout><![CDATA[
<template:insert template="template.jsp">

  <template:put name="title">An example page</template:put>

  <template:put name="content">
    <p>This page shows you all the ...</p>
  </template:put>

  <template:put name='footer' content='footer.html'/>

</template:insert>
]]></literallayout>
</example>

<para>
The JSP page above produces content in the named slots, which will be
filled into the template shown below (which is the
<filename>template.jsp</filename> page) in the named locations.
</para>

<example>
<title>Defining the slots (<filename>template.jsp</filename>)</title>
<literallayout><![CDATA[
<html>
<head>
  <link rel=stylesheet type="text/css" href="default.css">
  <title><template:get name='title'/></title>
</head>

<body>
  <h1><template:get name='title'/></h1>

  <template:get name="content"/>
  <template:get name="footer"/>
</body>
</html>
]]></literallayout>
</example>

<example>
<title>Example for external reused data
(<filename>footer.html</filename>)</title>
<literallayout><![CDATA[
  <hr>
  <address>
    Ontopia A/S
  </address>
]]></literallayout>
</example>

</refsect1>

</refentry>

<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

<refentry id="template-put"> 
<refnamediv> 
<refname>put</refname> 

<refpurpose>Used in pages to put produced content into a named slot in
the template used by that page.
</refpurpose>
</refnamediv>
 
<refsect1> 
<title>Context interaction</title>

<para>
Must have an <symbol>insert</symbol> tag among its ancestors.
</para>

<para>
The tag makes no assumptions about its children, whose output it will
capture and store in order to fill it into the template. It may
contain one <symbol>split</symbol> tag as well any number of
<symbol>put</symbol> tags. The <symbol>split</symbol> tag allows the
named slot to be output by a nested <symbol>get</symbol> tag.
</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 

<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>name</entry> 
      <entry>Yes</entry> 
      <entry>String</entry> 
      <entry>The name of the slot in the template to write the content
      produced by the children of this tag into.</entry>
    </row> 
    <row> 
      <entry>content</entry> 
      <entry>No</entry> 
      <entry>String | Path</entry> 
      <entry>Gives the content of the named slot either as a string
      (if <symbol>direct</symbol> is true) or as a reference to a file
      which holds the contents (if <symbol>direct</symbol> is false).
      </entry>
    </row> 
    <row> 
      <entry>direct</entry> 
      <entry>No</entry> 
      <entry>true | false</entry> 
      <entry>If set to "true", will insert the contents of the
      <symbol>content</symbol> attribute as the slot content.</entry>
    </row> 
  </tbody> 
</tgroup> 
</informaltable> 
</refsect1>

<refsect1>
<title>Execution</title>

<para>
The children of the tag are executed, and their output captured. That
output is then taken by the <symbol>insert</symbol> tag and inserted
into the correct slot in the template, which is output.
</para>
</refsect1>

<refsect1>
<title>Example</title>

<para>
See the example given for the <symbol>insert</symbol> tag.
</para>
</refsect1>
</refentry> 

<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

<refentry> 

<refnamediv> 
<refname>get</refname> 

<refpurpose>Used in template pages to define slots into which content
will be inserted by pages using the template.</refpurpose>
</refnamediv>

<refsect1> 
<title>Context interaction</title>

<para>This tag makes no assumption about its ancestors.</para>

<para>This tag may have content if it outputs a slot from a
<symbol>put</symbol> tag that had a <symbol>split</symbol>
child. If not it must be empty.</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 

<informaltable> 
<tgroup cols="4"> 
  <thead> 
    <row> 
      <entry>Name</entry> 
      <entry>Required</entry> 
      <entry>Values</entry> 
      <entry>Description</entry> 
    </row> 
  </thead> 
  <tbody> 
    <row> 
      <entry>name</entry> 
      <entry>Yes</entry> 
      <entry>String</entry> 
      <entry>The name of the slot whose contents are to be inserted to
      replace this tag when the template is used.</entry> 
    </row> 
  </tbody> 
</tgroup> 
</informaltable> 
</refsect1>

<refsect1>
<title>Execution</title>

<para>
When the template is used the contents of the named slot (as produced
by the using page) are looked up and inserted in place of this tag. If
no content has been filled into the slot the tag will not output
anything. 
</para>

<para>
If the slot referred to was from a <symbol>put</symbol> tag that had a
<symbol>split</symbol> child the start tag for the
<symbol>get</symbol> will output the slot up to the split point, then
output the result of evaluating its content, and finally the end tag
will output the slot after the split point.
</para>
</refsect1>

<refsect1>
<title>Example</title>

<para>
See the example given for the <symbol>insert</symbol> tag.
</para>
</refsect1>
</refentry>

<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

<refentry> 
<refnamediv> 
<refname>split</refname> 

<refpurpose>Used in template pages inside <symbol>put</symbol> tags to
split the slot so that it can be output by a nested
<symbol>get</symbol> tag.</refpurpose>
</refnamediv>

<refsect1> 
<title>Context interaction</title>

<para>This tag must have a <symbol>put</symbol> tag among its
ancestors.</para>

<para>This tag must be empty.</para>
</refsect1>

<refsect1> 
<title>Attributes</title> 

<para>
This tag has no attributes.
</para> 
</refsect1>

<refsect1>
<title>Execution</title>

<para>
The tag informs its nearest ancestor <symbol>put</symbol> tag that
this is the split point for this slot. No other actions are performed.
</para>
</refsect1>

<refsect1>
<title>Example</title>

<para>
Below is an example of how the <symbol>split</symbol> tag is used.
The <filename>demo.jsp</filename> requested by the
client uses the template (as defined in
<filename>template.jsp</filename> as listed a bit further down).
</para>

<example>
<title>Referring to the template with the insert tag
(<filename>demo.jsp</filename>)</title>

<literallayout><![CDATA[
<template:insert template="template.jsp">

  <template:put name="title">An example page</template:put>

  <template:put name="content">
    <form ...>

      <template:split/>

      <template:put name="menu">
        <input type=button name=button1 value="Button1">
        <input type=button name=button2 value="Button2">
      </template:put>

      <template:put name="body">
        <input type=text name=field>
      </template:put>

    </form>
  </template:put>

  <template:put name='footer' content='footer.html'/>

</template:insert>
]]></literallayout>
</example>

<para>
The JSP page above produces a web form that contains a menu (as a
template slot), consisting of a row of buttons that submit the form,
and the form body (as another template slot).
</para>

<example>
<title>Defining the slots (<filename>template.jsp</filename>)</title>
<literallayout><![CDATA[
<html>
<head>
  <link rel=stylesheet type="text/css" href="default.css">
  <title><template:get name='title'/></title>
</head>

<body>
  <h1><template:get name='title'/></h1>

  <template:get name="content">
    <table>
    <tr><td><template:get name="menu"/>

    <tr><td><template:get name="content"/>

    <tr><td><template:get name="menu"/>
    </table>
  </template:get>

  <template:get name="footer"/>
</body>
</html>
]]></literallayout>
</example>

<para>
In this template the <symbol>get</symbol> start tag for the 'content'
slot outputs the form start tag (basically the 'content' slot up to
the <symbol>split</symbol> tag), then the content of the
<symbol>get</symbol> tag is output with the slots inserted, and
finally the end tag outputs the form end tag.
</para>
</refsect1>
</refentry>

</section>

</article>
